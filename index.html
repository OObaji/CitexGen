<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citex Question Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a; /* Force Dark Background */
        }
        
        #landingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-input {
            background: rgba(31, 41, 55, 0.5);
            border: 1px solid rgba(75, 85, 99, 0.6);
            transition: all 0.3s ease;
            color: #e5e7eb;
        }
        .glass-input:focus {
            background: rgba(31, 41, 55, 0.8);
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .output-block {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-200 transition-colors duration-300 overflow-x-hidden">

    <div id="landingPage" class="relative min-h-screen flex flex-col items-center justify-center text-center overflow-hidden p-4">
        <canvas id="landingCanvas"></canvas>
        <div class="z-10 relative glass-panel p-10 md:p-16 rounded-3xl shadow-2xl max-w-3xl mx-auto border-t border-white/60">
            <div class="mb-6 flex justify-center">
                <div class="bg-indigo-900/30 p-3 rounded-2xl">
                    <svg class="w-12 h-12 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-violet-400 mb-6 tracking-tight">Citex</h1>
            <p class="text-xl md:text-2xl text-slate-300 mb-8 leading-relaxed">The intelligent citation engine.<br class="hidden md:block">Generate dynamic, style-specific questions instantly.</p>
            <button id="getStartedBtn" class="group relative inline-flex items-center justify-center px-8 py-4 font-semibold text-white transition-all duration-200 bg-gradient-to-r from-indigo-600 to-violet-600 rounded-full hover:from-indigo-700 hover:to-violet-700 focus:outline-none focus:ring-offset-2 focus:ring-4 focus:ring-indigo-500 shadow-lg hover:shadow-indigo-500/30 hover:-translate-y-1">
                <span>Start Generating</span>
                <svg class="w-5 h-5 ml-2 -mr-1 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
            </button>
        </div>
    </div>

    <div id="generatorPage" class="hidden min-h-screen relative z-10">
        <div class="container mx-auto p-4 sm:p-6 lg:p-12 max-w-5xl">
            <header class="flex flex-col md:flex-row justify-between items-center mb-10 fade-in-up" style="animation-delay: 0.1s">
                <div class="flex items-center gap-3 mb-4 md:mb-0 cursor-pointer group" id="homeTitle" title="Back to Home">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Citex Generator</h1>
                        <p class="text-xs text-slate-400 font-medium uppercase tracking-wider">Academic Tools</p>
                    </div>
                </div>
            </header>

            <main class="glass-panel rounded-3xl shadow-2xl p-6 md:p-10 fade-in-up" style="animation-delay: 0.2s">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-8">
                    <div class="lg:col-span-7 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                            <label for="questionCategory" class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">Category</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></div>
                                <select id="questionCategory" class="glass-input w-full pl-10 p-3 rounded-xl focus:outline-none appearance-none cursor-pointer text-white">
                                    <option value="reference_list">Reference List</option>
                                    <option value="in_text">In-text Citation</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                            </div>
                        </div>

                        <div id="subCategoryContainer" class="col-span-1 hidden">
                            <label for="inTextSubCategory" class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">Author Count</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg></div>
                                <select id="inTextSubCategory" class="glass-input w-full pl-10 p-3 rounded-xl focus:outline-none appearance-none cursor-pointer text-white">
                                    <option value="mixed">Mixed</option>
                                    <option value="single">Single Author</option>
                                    <option value="two">Two Authors</option>
                                    <option value="three">Three Authors</option>
                                    <option value="four_plus">More than 3 Authors</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                            </div>
                        </div>

                        <div class="col-span-1">
                            <label for="numQuestions" class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">Quantity</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg></div>
                                <input type="number" id="numQuestions" value="5" min="1" max="20" class="glass-input w-full pl-10 p-3 rounded-xl focus:outline-none text-white">
                            </div>
                        </div>

                        <div class="col-span-1">
                            <label for="citationStyle" class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">Citation Style</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg></div>
                                <select id="citationStyle" class="glass-input w-full pl-10 p-3 rounded-xl focus:outline-none appearance-none cursor-pointer text-white">
                                    <option value="harvard">Harvard</option>
                                    <option value="mla9">MLA 9th Ed.</option>
                                    <option value="apa7">APA 7th Ed.</option>
                                    <option value="chicago">Chicago (NB)</option>
                                    <option value="mhra">MHRA</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none"><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>
                            </div>
                        </div>

                        <div class="col-span-1 md:col-span-2 bg-slate-800/40 rounded-xl p-4 border border-slate-700">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3 tracking-wide">Output Formats</label>
                            <div class="flex space-x-6">
                                <label class="inline-flex items-center cursor-pointer group">
                                    <div class="relative">
                                        <input id="dndCheckbox" name="questionType" type="checkbox" checked class="peer sr-only">
                                        <div class="w-5 h-5 border-2 border-slate-600 rounded bg-slate-700 peer-checked:bg-indigo-600 peer-checked:border-indigo-600 transition-all"></div>
                                        <svg class="w-3 h-3 text-white absolute top-1 left-1 opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                    <div class="flex flex-col ml-2"><span class="text-slate-300 font-semibold">Drag & Drop</span><span class="text-[10px] text-slate-500 uppercase tracking-wider">Build Citations</span></div>
                                </label>
                                <label class="inline-flex items-center cursor-pointer group">
                                    <div class="relative">
                                        <input id="mcqCheckbox" name="questionType" type="checkbox" checked class="peer sr-only">
                                        <div class="w-5 h-5 border-2 border-slate-600 rounded bg-slate-700 peer-checked:bg-indigo-600 peer-checked:border-indigo-600 transition-all"></div>
                                        <svg class="w-3 h-3 text-white absolute top-1 left-1 opacity-0 peer-checked:opacity-100 transition-opacity pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                                    </div>
                                    <div class="flex flex-col ml-2"><span class="text-slate-300 font-semibold">Multi Choice</span><span class="text-[10px] text-slate-500 uppercase tracking-wider">Identify Correct</span></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-5 flex flex-col h-full">
                        <label for="sourceType" class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wide">Source Types (Ctrl+Click)</label>
                        <select id="sourceType" multiple class="glass-input w-full flex-grow rounded-xl p-2 focus:outline-none text-sm text-white" style="min-height: 220px;"></select>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center mb-10">
                    <button id="generateBtn" class="w-full sm:w-auto bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white font-bold py-3 px-10 rounded-xl shadow-lg transform transition hover:-translate-y-0.5 focus:ring-4 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        Generate
                    </button>
                    <button id="downloadBtn" class="hidden w-full sm:w-auto bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-10 rounded-xl shadow-lg transform transition hover:-translate-y-0.5 focus:ring-4 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Export .DOCX
                    </button>
                </div>

                <div id="output" class="hidden space-y-6">
                    <div class="rounded-xl overflow-hidden shadow-2xl border border-slate-700">
                        <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 flex items-center justify-between">
                            <div class="flex gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><div class="w-3 h-3 rounded-full bg-amber-500"></div><div class="w-3 h-3 rounded-full bg-green-500"></div></div>
                            <div class="text-xs text-slate-400 font-mono">results.html</div>
                            <button onclick="copyToClipboard('htmlOutput')" class="text-xs flex items-center gap-1 text-slate-300 hover:text-indigo-400 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg> Copy
                            </button>
                        </div>
                        <div id="htmlOutput" class="p-6 bg-slate-900 text-slate-200 text-sm font-mono leading-relaxed overflow-x-auto output-block border-l-4 border-indigo-500"></div>
                    </div>
                </div>

                <div id="messageBox" class="hidden fixed top-5 right-5 z-50 bg-slate-800 text-white py-3 px-6 rounded-xl shadow-xl transition-all duration-300 transform translate-y-0 flex items-center gap-3">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span id="msgText">Action successful</span>
                </div>
            </main>
        </div>
    </div>

    <script>
        let lastGeneratedQuestions = [];
        const data = {
            authors: [{ first: 'J.', last: 'Smith' }, { first: 'A.', last: 'Doe' }, { first: 'M.', last: 'Lee' }, { first: 'S.', last: 'Kim' }, { first: 'R.', last: 'Chen' }, { first: 'L.', last: 'Wang' }, { first: 'P.', last: 'Brown' }, { first: 'K.', last: 'Patel' }, { first: 'T.', last: 'Jones' }, { first: 'B.', last: 'White' }, { first: 'H.', last: 'Green' }, { first: 'D.', last: 'Black' }],
            editors: [{ first: 'E.', last: 'Cole' }, { first: 'B.', last: 'Wood' }, { first: 'C.', last: 'Page' }],
            bookTitles: ['Modern Art', 'Future Tech', 'Clean Energy', 'World History', 'Deep Space', 'AI Ethics', 'Biology 101', 'Smart Cities', 'Urban Life', 'Digital Age', 'Basic Math', 'Psychology'],
            chapterTitles: ['Introduction', 'Methods', 'Results', 'Analysis', 'Overview', 'Case Study', 'Summary', 'Background'],
            journalTitles: ['Nature', 'Science', 'Cell', 'JAMA', 'Lancet', 'BMJ', 'IEEE', 'PLOS One', 'Time'],
            articleTitles: ['Gene Study', 'Solar Power', 'New Vaccine', 'Climate Data', 'AI Trends', 'Mental Health', 'Ocean Life', 'Space Travel'],
            publisherLocations: [{ publisher: 'Penguin', location: 'London' }, { publisher: 'Wiley', location: 'New York' }, { publisher: 'Sage', location: 'Boston' }, { publisher: 'Oxford', location: 'Oxford' }, { publisher: 'MIT', location: 'Boston' }],
            organizations: ['WHO', 'NASA', 'CDC', 'UN', 'EPA', 'IEEE', 'WTO', 'IMF'],
            webTitles: ['2024 Report', 'Guidelines', 'Statistics', 'Home Page', 'About Us', 'Safety Data']
        };
        const sourceTypes = [
            { value: 'book', text: 'Books' }, { value: 'edited_book', text: 'Edited Books' },
            { value: 'journal', text: 'Journal articles' }, { value: 'website', text: 'Websites' }
        ];

        function getRandomItem(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        function formatScenarioNameList(people) {
            const names = people.map(p => `${p.first} ${p.last}`);
            if (names.length === 1) return names[0];
            if (names.length === 2) return names.join(' and ');
            return names.slice(0, -1).join(', ') + ', and ' + names.slice(-1);
        }
        function showMessageBox(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            const msgText = document.getElementById('msgText');
            msgText.textContent = message;
            if (type === 'error') {
               messageBox.querySelector('svg').classList.replace('text-green-400', 'text-red-400');
               messageBox.querySelector('path').setAttribute('d', 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z');
            } else {
               messageBox.querySelector('svg').classList.replace('text-red-400', 'text-green-400');
               messageBox.querySelector('path').setAttribute('d', 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 3000);
        }
        function cleanHtmlTags(text) { return String(text).replace(/<i>/g, '').replace(/<\/i>/g, '').replace(/<span.*?>/g, '').replace(/<\/span>/g, ''); }
        function updateSourceTypes() {
            const sourceDropdown = document.getElementById('sourceType');
            const currentSourceValues = Array.from(sourceDropdown.selectedOptions).map(opt => opt.value);
            sourceDropdown.innerHTML = '';
            sourceTypes.forEach(source => {
                const option = document.createElement('option');
                option.value = source.value;
                option.textContent = source.text;
                if (currentSourceValues.includes(source.value)) { option.selected = true; }
                sourceDropdown.appendChild(option);
            });
            if (sourceDropdown.selectedOptions.length === 0) { sourceDropdown.selectedIndex = 0; }
        }

        // --- CORE GENERATOR FUNCTIONS ---
        
        function getScenarioHint(style, scenario) {
            const hints = {
                'apa7': {
                    1: "APA 7: Author. (Year). Title. Publisher.",
                    2: "APA 7: Use an ampersand (&) between the two authors' names.",
                    3: "APA 7: List all authors up to 20; use '&' before the last one.",
                    4: "APA 7: List all authors up to 20; use '&' before the last one.",
                    5: "APA 7: Place the edition in parentheses after the title, e.g., (2nd ed.).",
                    6: "APA 7: Do not include the place of publication.",
                    7: "APA 7: Use the publisher's name as shown on the work.",
                    8: "APA 7: Use the organization name. If no author, move title to front."
                },
                'harvard': {
                    1: "Harvard: Author (Year) Title. Place: Publisher.",
                    2: "Harvard: Join names with 'and' (no ampersand usually, though varies).",
                    3: "Harvard: Use commas and 'and' for the last author.",
                    4: "When a book has four or more authors, use the first author's surname and initials followed by the Latin abbreviation for 'and others.'",
                    5: "Place the specific edition abbreviation immediately after the title; ensure initials are spaced correctly.",
                    6: "Harvard: Include the city of publication followed by a colon.",
                    7: "Harvard: State the publisher's name clearly.",
                    8: "Use the full official name of the organization as the author and avoid using acronyms."
                },
                'mla9': {
                    1: "MLA 9: Author. Title. Publisher, Year.",
                    2: "MLA 9: List both authors separated by 'and'.",
                    3: "MLA 9: Use 'et al.' for 3 or more authors.",
                    4: "MLA 9: Use 'et al.' for 3 or more authors.",
                    5: "MLA 9: Edition goes after title, e.g., '2nd ed.'",
                    6: "MLA 9: City of publication is optional but often omitted.",
                    7: "MLA 9: Publisher name, Year.",
                    8: "MLA 9: Organization name as author."
                },
                'chicago': {
                    1: "Chicago: Author. Title. Place: Publisher, Year.",
                    2: "Chicago: List both authors.",
                    3: "Chicago: List all three authors.",
                    4: "Chicago: List first author followed by 'et al.' in reference list mostly for 10+, but context implies 4+ here.",
                    5: "Chicago: Edition follows title.",
                    6: "Chicago: City: Publisher.",
                    7: "Chicago: Publisher name.",
                    8: "Chicago: Organization as author."
                },
                'mhra': {
                    1: "MHRA: Author, Title (Place: Publisher, Year).",
                    2: "MHRA: List both authors.",
                    3: "MHRA: List all three authors.",
                    4: "MHRA: List first author 'et al.' if 4+.",
                    5: "MHRA: Edition follows title.",
                    6: "MHRA: Place: Publisher.",
                    7: "MHRA: Publisher name.",
                    8: "MHRA: Organization as author."
                }
            };
            return hints[style]?.[scenario] || "Arrange: Author, Date, Title, Publication.";
        }

        function generateQuestions() {
            const numQuestions = parseInt(document.getElementById('numQuestions').value) || 1;
            const citationStyle = document.getElementById('citationStyle').value;
            const category = document.getElementById('questionCategory').value;
            const inTextSubCategory = document.getElementById('inTextSubCategory').value;
            const selectedSourceTypes = Array.from(document.getElementById('sourceType').selectedOptions).map(opt => opt.value);
            const selectedQuestionTypes = [];
            if (document.getElementById('dndCheckbox').checked) selectedQuestionTypes.push('dnd');
            if (document.getElementById('mcqCheckbox').checked) selectedQuestionTypes.push('mcq');

            if (selectedSourceTypes.length === 0 || selectedQuestionTypes.length === 0) {
                showMessageBox("Please select at least one Source Type and one Output Format.", 'error');
                return;
            }

            // Create a fresh pool and logic to ensure unique items in one pass
            const dynamicDataPool = JSON.parse(JSON.stringify(data));
            const getUniqueItem = (key) => {
                if (!dynamicDataPool[key] || dynamicDataPool[key].length === 0) {
                     dynamicDataPool[key] = [...data[key]]; // Refill if empty
                }
                const index = Math.floor(Math.random() * dynamicDataPool[key].length);
                return dynamicDataPool[key].splice(index, 1)[0]; // Remove to ensure uniqueness
            };

            let allQuestionsOutput = '';
            lastGeneratedQuestions = [];

            const getStyleName = (s) => ({ 'apa7': 'APA7', 'mla9': 'MLA9', 'harvard': 'Harvard', 'chicago': 'Chicago', 'mhra': 'MHRA' }[s] || s);
            const getCatName = (c) => ({ 'reference_list': 'ReferenceList', 'in_text': 'InText' }[c] || c);
            const getSourceName = (s) => ({ 'book': 'Book', 'edited_book': 'EditedBook', 'journal': 'Journal', 'website': 'Website' }[s] || s);

            for (let i = 0; i < numQuestions; i++) {
                let activeCategory = category;
                const sourceType = getRandomItem(selectedSourceTypes);
                const questionType = getRandomItem(selectedQuestionTypes);
                let questionData = {};
                let htmlQuestionPart = '';
                const titlePrefix = `${getStyleName(citationStyle)} | ${getCatName(activeCategory)} | ${getSourceName(sourceType)} | ${questionType === 'dnd' ? 'DragDrop' : 'MCQ'} | Q${i+1}`;

                // --- REFERENCE LIST ---
                if (activeCategory === 'reference_list') {
                     if (sourceType === 'book') {
                        questionData = generateBookScenarioData(getUniqueItem, citationStyle); // Use special book logic for Ref List
                    } else {
                        // Other source types
                        const generatorMap = {
                            'apa7-edited_book': () => generateApaEditedBook(getUniqueItem, getRandomItem([1,2])), 
                            'apa7-journal': () => generateApaJournal(getUniqueItem, getRandomItem([1,2])), 
                            'apa7-website': () => generateApaWebsite(getUniqueItem), 
                            'mla9-edited_book': () => generateMlaEditedBook(getUniqueItem, getRandomItem([1,2])), 
                            'mla9-journal': () => generateMlaJournal(getUniqueItem, getRandomItem([1,2])), 
                            'mla9-website': () => generateMlaWebsite(getUniqueItem), 
                            'harvard-edited_book': () => generateHarvardEditedBook(getUniqueItem, getRandomItem([1,2])), 
                            'harvard-journal': () => generateHarvardJournal(getUniqueItem, getRandomItem([1,2])), 
                            'harvard-website': () => generateHarvardWebsite(getUniqueItem), 
                            'chicago-edited_book': () => generateChicagoEditedBook(getUniqueItem, getRandomItem([1,2])), 
                            'chicago-journal': () => generateChicagoJournal(getUniqueItem, getRandomItem([1,2])), 
                            'chicago-website': () => generateChicagoWebsite(getUniqueItem), 
                            'mhra-edited_book': () => generateMhraEditedBook(getUniqueItem, getRandomItem([1,2])), 
                            'mhra-journal': () => generateMhraJournal(getUniqueItem, getRandomItem([1,2])), 
                            'mhra-website': () => generateMhraWebsite(getUniqueItem)
                        };
                        const generatorKey = `${citationStyle}-${sourceType}`;
                        if (generatorMap[generatorKey]) questionData = generatorMap[generatorKey]();
                    }

                    if (questionData && questionData.components) {
                        questionData.baseTitle = titlePrefix;
                        if (questionType === 'dnd') {
                            const finalOutput = buildDragAndDrop(questionData, i + 1);
                            htmlQuestionPart = finalOutput.htmlOutput;
                        } else {
                            const mcqData = generateRefListMCQ(questionData); 
                            htmlQuestionPart = `Question Title:\n${questionData.baseTitle}\n\nQuestion:\n${mcqData.sentence}\n\nCorrect Answer:\n${mcqData.correctOption}\n\nOptions:\n${mcqData.options.join('\n')}\n\nHint/Explanation:\n${mcqData.hint}`;
                        }
                    } else { i--; continue; } // Retry if generation failed

                // --- IN-TEXT CITATION ---
                } else if (activeCategory === 'in_text') {
                    let numAuthors = 1;
                    if (inTextSubCategory === 'single') numAuthors = 1;
                    else if (inTextSubCategory === 'two') numAuthors = 2;
                    else if (inTextSubCategory === 'three') numAuthors = 3;
                    else if (inTextSubCategory === 'four_plus') numAuthors = 4; 
                    else numAuthors = getRandomItem([1, 2, 3, 4]);

                    if (questionType === 'mcq') {
                        questionData = generateInTextMCQ(getUniqueItem, citationStyle, numAuthors, sourceType);
                        questionData.baseTitle = titlePrefix;
                        htmlQuestionPart = `Question Title:\n${questionData.baseTitle}\n\nQuestion:\n${questionData.sentence}\n\nCorrect Answer:\n${questionData.correctOption}\n\nOptions:\n${questionData.options.join('\n')}\n\nHint/Explanation:\n${questionData.hint}`;
                    } else {
                        questionData = generateInTextDnD(getUniqueItem, citationStyle, numAuthors, sourceType);
                        questionData.baseTitle = titlePrefix;
                        const finalOutput = buildDragAndDrop(questionData, i + 1);
                        htmlQuestionPart = finalOutput.htmlOutput;
                    }
                }

                const questionHeader = `Question ${i + 1}\n`;
                const cleanedQuestionText = cleanHtmlTags(questionHeader + htmlQuestionPart);
                allQuestionsOutput += cleanedQuestionText + '\n\n'; 
                lastGeneratedQuestions.push(cleanedQuestionText);
            }

            document.getElementById('htmlOutput').innerText = allQuestionsOutput;
            document.getElementById('output').classList.remove('hidden');
            document.getElementById('downloadBtn').classList.remove('hidden');
            document.getElementById('output').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // --- BOOK SCENARIO GENERATOR (8 Scenarios) ---
        function generateBookScenarioData(getUniqueItem, style) {
            const scenario = getRandomItem([1, 2, 3, 4, 5, 6, 7, 8]);
            
            let authors = [];
            let isCorp = false;
            let isAnon = false;
            let edition = "";
            let place = getUniqueItem('publisherLocations').location;
            let pub = getUniqueItem('publisherLocations').publisher;
            let year = Math.floor(Math.random() * (2027 - 2023 + 1)) + 2023; 
            let title = getUniqueItem('bookTitles');
            let distractors = [];
            let scenarioName = "";

            if (scenario === 1) { // Single
                scenarioName = "Single Author (Scenario 1)";
                authors = [getUniqueItem('authors')];
                distractors.push(`${authors[0].last}`, `(n.d.)`, `(${year})`);
            } else if (scenario === 2) { // Two
                scenarioName = "Two Authors (Scenario 2)";
                authors = [getUniqueItem('authors'), getUniqueItem('authors')];
                distractors.push(`${authors[0].last} ${authors[1].last}`, `${authors[1].last} and ${authors[0].last}`);
            } else if (scenario === 3) { // Three
                scenarioName = "Three Authors (Scenario 3)";
                authors = [getUniqueItem('authors'), getUniqueItem('authors'), getUniqueItem('authors')];
                distractors.push(`${authors[0].last}, ${authors[2].last}`, `${authors[0].last} & ${authors[1].last}`);
            } else if (scenario === 4) { // Four+
                scenarioName = "4+ Authors (Scenario 4)";
                authors = [getUniqueItem('authors'), getUniqueItem('authors'), getUniqueItem('authors'), getUniqueItem('authors')];
                distractors.push(`${authors[0].last} et al.`, `${authors[0].last} and others`);
            } else if (scenario === 5) { // Edition
                scenarioName = "Edition Variations (Scenario 5)";
                authors = [getUniqueItem('authors')];
                const edNum = getRandomItem(['2nd', '3rd', '4th']);
                edition = edNum;
                distractors.push(`${edNum} Edition`, `(${edNum} edit.)`);
            } else if (scenario === 6) { // Place
                scenarioName = "Place Variations (Scenario 6)";
                authors = [getUniqueItem('authors')];
                distractors.push(`${pub}: ${place}`, `${place}`);
            } else if (scenario === 7) { // Publisher
                scenarioName = "Publisher Variations (Scenario 7)";
                authors = [getUniqueItem('authors')];
                distractors.push(`${pub} Press`, `Pub. ${pub}`);
            } else if (scenario === 8) { // Corp/Anon
                scenarioName = "Special Author Cases - Corporate (Scenario 8)"; 
                if (Math.random() > 0.5) {
                    isCorp = true;
                    authors = [{ last: getUniqueItem('organizations'), first: '' }];
                    distractors.push(`(Org.)`, `${authors[0].last} Inc.`);
                } else {
                    scenarioName = "Special Author Cases - Anonymous (Scenario 8)";
                    isAnon = true;
                    authors = [{ last: 'Anonymous', first: '' }];
                    distractors.push(`Anon.`, `(Anon)`);
                }
            }
            
            let authText = "";
            if (isCorp) authText = `${authors[0].last}`;
            else if (isAnon) authText = `an anonymous author`;
            else authText = formatScenarioNameList(authors);
            
            let edText = edition ? `, ${edition} edition` : "";
            let scenarioText = `You are citing a ${edition ? edition + ' edition of a ' : ''}${year} book titled "${title}" ${isCorp || isAnon ? 'published' : 'written'} by ${authText} published by ${pub} in ${place}.`;

            let components = {};
            let hint = getScenarioHint(style, scenario);
            
            if (style === 'apa7') {
                let authorStr = "";
                if (isAnon) authorStr = title; 
                else if (isCorp) authorStr = authors[0].last + ".";
                else {
                    const names = authors.map(a => `${a.last}, ${a.first.charAt(0)}.`);
                    if (names.length > 1) authorStr = names.slice(0, -1).join(', ') + ', & ' + names.slice(-1);
                    else authorStr = names[0];
                }
                let titleStr = `<i>${title}</i>`;
                let edStr = edition ? `(${edition} ed.).` : "";
                if(isAnon) {
                     components = { content: [`<i>${title}</i>.`, `(${year}).`, `${pub}.`], structure: '{0} {1} {2}', distractors: [...distractors, `Anonymous.`] };
                } else {
                    components = {
                        content: [authorStr, `(${year}).`, titleStr, ...(edition ? [edStr] : []), `${pub}.`],
                        structure: edition ? '{0} {1} {2} {3} {4}' : '{0} {1} {2}. {3}', 
                        distractors: [...distractors, `${place}`]
                    };
                }
            } else if (style === 'mla9') {
                let authorStr = "";
                if (isAnon) authorStr = "";
                else if (isCorp) authorStr = authors[0].last + ".";
                else {
                    if (authors.length === 1) authorStr = `${authors[0].last}, ${authors[0].first}.`;
                    else if (authors.length === 2) authorStr = `${authors[0].last}, ${authors[0].first}, and ${authors[1].first} ${authors[1].last}.`;
                    else authorStr = `${authors[0].last}, ${authors[0].first}, et al.`;
                }
                let titleStr = `<i>${title}</i>.`;
                let edStr = edition ? `${edition} ed.,` : "";
                let content = [];
                if(authorStr) content.push(authorStr);
                content.push(titleStr);
                if(edition) content.push(edStr);
                content.push(pub + ",", year + ".");
                
                let s = "";
                for(let i=0; i<content.length; i++) s += `{${i}} `;
                s = s.trim();
                components = { content: content, structure: s, distractors: [...distractors, `${place}`] };
            } else if (style === 'harvard') {
                let authorStr = "";
                if (isAnon) authorStr = "Anon.";
                else if (isCorp) authorStr = authors[0].last;
                else {
                    if (scenario === 4) {
                        authorStr = `${authors[0].last}, ${authors[0].first.charAt(0)}. et al.`;
                    } else {
                        const names = authors.map(a => `${a.last}, ${a.first.charAt(0)}.`);
                        if (names.length > 1) authorStr = names.slice(0, -1).join(', ') + ' and ' + names.slice(-1);
                        else authorStr = names[0];
                    }
                }
                let edStr = edition ? `${edition} edn.` : "";
                components = {
                    content: [authorStr, `(${year})`, `<i>${title}</i>.`, ...(edition?[edStr]:[]), `${place}:`, `${pub}.`],
                    structure: edition ? '{0} {1} {2} {3} {4} {5}' : '{0} {1} {2} {3} {4}', 
                    distractors: distractors
                };
            } else if (style === 'chicago') {
                 let authorStr = "";
                if(isAnon) authorStr = ""; 
                else if(isCorp) authorStr = authors[0].last + ".";
                else {
                    if(authors.length === 1) authorStr = `${authors[0].last}, ${authors[0].first}.`;
                    else {
                        let first = `${authors[0].last}, ${authors[0].first}`;
                        let others = authors.slice(1).map(a => `${a.first} ${a.last}`).join(', and ');
                        authorStr = `${first}, and ${others}.`;
                    }
                }
                let edStr = edition ? `${edition} ed.` : "";
                let content = [];
                if(authorStr) content.push(authorStr);
                content.push(`<i>${title}</i>.`);
                if(edition) content.push(edStr);
                content.push(`${place}:`);
                content.push(`${pub},`);
                content.push(`${year}.`);
                let s = "";
                for(let i=0; i<content.length; i++) s += `{${i}} `;
                s = s.trim();
                components = { content: content, structure: s, distractors: distractors };
            } else if (style === 'mhra') {
                let authorStr = "";
                 if(isAnon) authorStr = "Anon.,";
                 else if(isCorp) authorStr = authors[0].last + ",";
                 else {
                     let names = authors.map(a => `${a.last}, ${a.first}`);
                     if(names.length > 1) authorStr = names.slice(0, -1).join(', ') + ' and ' + names.slice(-1) + ",";
                     else authorStr = names[0] + ",";
                 }
                 let edStr = edition ? `, ${edition} edn` : "";
                 components = {
                     content: [authorStr, `<i>${title}</i>`, ...(edition?[edStr]:[]), `(${place}:`, `${pub},`, `${year})`],
                     structure: edition ? '{0} {1}{2} {3} {4} {5}' : '{0} {1} {3} {4} {5}', 
                     distractors: distractors
                 };
            }

            return { scenario: scenarioText, components: components, hint: hint, originalTitle: title, scenarioName: scenarioName };
        }

        // --- In-Text & Helper Logic ---

        function buildDragAndDrop(questionData, questionNumber) {
            const { baseTitle, scenario, components, hint, scenarioName } = questionData;
            
            const totalItems = components.content.length;
            let maxHide = 4;
            let minHide = 2;
            if (totalItems < minHide) minHide = totalItems;
            if (maxHide > totalItems) maxHide = totalItems;
            
            const draggableCount = Math.floor(Math.random() * (maxHide - minHide + 1)) + minHide;
            const allIndices = Array.from(Array(totalItems).keys());
            const shuffledIndices = shuffleArray(allIndices);
            const draggableIndices = new Set(shuffledIndices.slice(0, draggableCount));
            
            let correctDragItems = components.content.filter((_, i) => draggableIndices.has(i));
            correctDragItems = shuffleArray([...correctDragItems]);

            let fullCorrectString = components.structure;
            allIndices.forEach(i => {
                fullCorrectString = fullCorrectString.replace(`{${i}}`, components.content[i]);
            });
            fullCorrectString = cleanHtmlTags(fullCorrectString);

            let fixedPartsString = components.structure;
            const GAP_TOKEN = "___MISSING___";
            
            allIndices.forEach(i => {
                const placeholder = `{${i}}`;
                if (draggableIndices.has(i)) {
                    fixedPartsString = fixedPartsString.replace(placeholder, GAP_TOKEN);
                } else {
                    fixedPartsString = fixedPartsString.replace(placeholder, components.content[i]);
                }
            });
            
            // Logic to replace GAP_TOKEN based on position
            fixedPartsString = fixedPartsString.replace(/^\s*___MISSING___/, '|');
            fixedPartsString = fixedPartsString.replace(/___MISSING___(\s*[.,;:)]*)$/, '|$1');
            fixedPartsString = fixedPartsString.replace(/___MISSING___/g, '||');
            
            // Formatting
            fixedPartsString = fixedPartsString.replace(/\s+/g, ' ');
            fixedPartsString = fixedPartsString.replace(/(\|\|?)/g, ' $1 ');
            fixedPartsString = fixedPartsString.replace(/\s+/g, ' ').trim();

            const allCorrectComponents = components.content.map(item => cleanHtmlTags(String(item)));
            let smartDistractors = [];
            
            components.content.forEach((compRaw, index) => {
                if (!draggableIndices.has(index)) return; 
                const comp = cleanHtmlTags(String(compRaw));
                if (comp.endsWith('.')) smartDistractors.push(comp.slice(0, -1) + ','); 
                else if (comp.endsWith(',')) smartDistractors.push(comp.slice(0, -1) + '.');
                else smartDistractors.push(comp + '.');
            });

            const trickyCommonWords = ['n.d.', '(n.d.)', 'Vol.', 'pg.', 'Ed.', '&', 'and'];
            let potentialDistractors = [...(components.distractors || []), ...smartDistractors, ...trickyCommonWords];
            const uniqueDistractors = [...new Set(potentialDistractors)].filter(d => !allCorrectComponents.includes(d));
            const distractingWords = shuffleArray(uniqueDistractors).slice(0, 3);

            const scenLine = scenarioName ? `Scenario: ${scenarioName}` : "";
            
            const htmlOutput = `Question Title:\n${baseTitle}\n${scenLine}\nQuestion:\n${scenario}\n\nQuestion Parts (Correct Drag Items):\n${correctDragItems.map(item => cleanHtmlTags(item)).join('\n')}\n\nFixed Parts:\n${cleanHtmlTags(fixedPartsString)}\n\nCorrect Answer:\n${fullCorrectString}\n\nConfusing Words (Distractor Drag Items):\n${distractingWords.map(item => cleanHtmlTags(item)).join('\n')}\n\nHint:\n${hint}`;
            return { htmlOutput: htmlOutput };
        }

        function generateRefListMCQ(questionData) {
            let correctString = questionData.components.structure;
            questionData.components.content.forEach((item, index) => {
                correctString = correctString.replace(`{${index}}`, item);
            });
            const d1 = correctString.replace(/\./g, ',').replace(/,$/, '.');
            const d2 = correctString.replace(/&/g, 'and').replace(/\(/g, '').replace(/\)/g, '');
            const d3 = correctString.replace(/<i>/g, '').replace(/<\/i>/g, '');
            const options = shuffleArray([correctString, d1, d2, d3]);
            return {
                sentence: `Select the correct reference format from the following:\n${questionData.scenario}`,
                correctOption: correctString,
                options: options,
                hint: questionData.hint
            };
        }

        function generateInTextDnD(getUniqueItem, style, numAuthors, sourceType) {
            const year = Math.floor(Math.random() * (2025 - 2022 + 1)) + 2022;
            const page = Math.floor(Math.random() * 90) + 10;
            let authors = [];
            if (sourceType === 'website') authors = [{last: getUniqueItem('organizations'), first:''}];
            else {
                let tempPool = JSON.parse(JSON.stringify(data.authors));
                for(let k=0; k<numAuthors; k++) {
                   const index = Math.floor(Math.random() * tempPool.length);
                   authors.push(tempPool.splice(index, 1)[0]);
                }
            }
            
            const type = getRandomItem(['narrative', 'parenthetical', 'quote']);
            const names = authors.map(a => a.last);
            let title = getUniqueItem('bookTitles');
            let scenario = "";
            let components = {};

            const getAuth = (mode) => {
                let s = "";
                if(style === 'apa7') {
                     if(names.length===1) s=names[0];
                     else if(names.length===2) s=mode==='nar' ? `${names[0]} and ${names[1]}` : `${names[0]} & ${names[1]}`;
                     else s=`${names[0]} et al.`;
                } else if(style === 'mla9') {
                     if(names.length===1) s=names[0];
                     else if(names.length===2) s=`${names[0]} and ${names[1]}`;
                     else s=`${names[0]} et al.`;
                } else if(style === 'harvard') {
                     if(names.length===1) s=names[0];
                     else if(names.length===2) s=mode==='nar' ? `${names[0]} and ${names[1]}` : `${names[0]} & ${names[1]}`;
                     else if(names.length===3) s=mode==='nar' ? `${names[0]}, ${names[1]} and ${names[2]}` : `${names[0]}, ${names[1]} & ${names[2]}`;
                     else s=`${names[0]} et al.`;
                } else if(style === 'chicago') {
                     if(names.length===1) s=names[0];
                     else if(names.length===2) s=`${names[0]} and ${names[1]}`;
                     else if(names.length===3) s=`${names[0]}, ${names[1]}, and ${names[2]}`;
                     else s=`${names[0]} et al.`;
                } else { // MHRA
                     if(names.length>3) s=`${names[0]} et al.`; else s=names.join(' and ');
                }
                return s;
            };

            let sourceNoun = "source"; 
            if (sourceType === 'book') sourceNoun = "book";
            else if (sourceType === 'journal') sourceNoun = "article";
            else if (sourceType === 'website') sourceNoun = "web report";

            if (type === 'narrative') {
                scenario = `A narrative citation for the ${sourceNoun} "${title}" by ${formatScenarioNameList(authors)} published in ${year}.`;
                let auth = getAuth('nar');
                if(style==='mhra') components={content:[`${auth}`], structure:'{0}', distractors:[`(${year})`]};
                else components={content:[`${auth}`, `(${year})`], structure:'{0} {1}', distractors:[`[${year}]`, `${year}`]};
            } else if (type === 'quote') {
                scenario = `A direct quote citation for page ${page} of the ${sourceNoun} "${title}" by ${formatScenarioNameList(authors)} published in ${year}.`;
                let auth = getAuth('par');
                if(style==='apa7') components={content:[`(${auth},`, `${year},`, `p. ${page})`], structure:'{0} {1} {2}', distractors:[`${year}`,`pg.`]};
                else if(style==='mla9') components={content:[`(${auth}`, `${page})`], structure:'{0} {1}', distractors:[`p.`, `${year}`]};
                else if(style==='harvard') components={content:[`(${auth}`, `${year}:`, `${page})`], structure:'{0} {1} {2}', distractors:[`p.`]};
                else components={content:[`(${auth}`, `${year})`], structure:'{0}, {1}', distractors:[`${page}`]};
            } else {
                scenario = `A parenthetical citation for the ${sourceNoun} "${title}" by ${formatScenarioNameList(authors)} published in ${year}.`;
                let auth = getAuth('par');
                if(style==='mhra') components={content:[`${auth}`], structure:'{0}', distractors:[`(${year})`]};
                else if(style==='mla9') components={content:[`(${auth})`], structure:'{0}', distractors:[`${year}`]};
                else components={content:[`(${auth}`, `${year})`], structure:'{0}, {1}', distractors:[`${auth}`]};
            }

            return { baseTitle: 'In-Text Citation', scenario: scenario, components: components, hint: `Style: ${style.toUpperCase()}`, originalTitle: title };
        }

        function generateInTextMCQ(getUniqueItem, style, numAuthors, sourceType) {
            const year = Math.floor(Math.random() * (2025 - 2022 + 1)) + 2022;
            const page = Math.floor(Math.random() * 90) + 10;
            const scenarioType = getRandomItem([1, 2, 3, 4]); // 1=Nar, 2=Par, 3=Quote, 4=Multi
            
            let rawAuthors = [];
            let tempPool = JSON.parse(JSON.stringify(data.authors));
            
            if (scenarioType === 4) {
                 for(let k=0; k<3; k++) {
                     const index = Math.floor(Math.random() * tempPool.length);
                     rawAuthors.push(tempPool.splice(index, 1)[0]);
                 }
                 rawAuthors.sort((a,b) => a.last.localeCompare(b.last));
            } else {
                 if (sourceType === 'website') rawAuthors = [{last: getUniqueItem('organizations'), first:''}];
                 else {
                     for(let k=0; k<numAuthors; k++) {
                        const index = Math.floor(Math.random() * tempPool.length);
                        rawAuthors.push(tempPool.splice(index, 1)[0]);
                     }
                 }
            }

            const getAuth = (mode) => {
                const n = rawAuthors.map(a => a.last);
                if(style === 'apa7') return n.length===1 ? n[0] : (n.length===2 ? (mode==='nar'?n.join(' and '):n.join(' & ')) : `${n[0]} et al.`);
                if(style === 'mla9') return n.length===1 ? n[0] : (n.length===2 ? n.join(' and ') : `${n[0]} et al.`);
                if(style === 'harvard') return n.length===1 ? n[0] : (n.length===2 ? (mode==='nar'?n.join(' and '):n.join(' & ')) : (n.length===3 ? (mode==='nar'?n.slice(0,2).join(', ')+' and '+n[2] : n.slice(0,2).join(', ')+' & '+n[2]) : `${n[0]} et al.`));
                if(style === 'chicago') return n.length===1 ? n[0] : (n.length<=3 ? (n.length===2?n.join(' and '):n.slice(0,2).join(', ')+', and '+n[2]) : `${n[0]} et al.`);
                return n[0];
            };

            let questionStem = "", correct = "";
            let auth = getAuth(scenarioType===1 || scenarioType===3 ? 'nar' : 'par');

            if (scenarioType === 1) {
                questionStem = "Which of the following is the correct way to cite a source?";
                correct = style==='mla9' ? `${auth} states...` : `${auth} (${year}) states...`;
            } else if (scenarioType === 2) {
                questionStem = "Select the correct way to present an in-text citation:";
                correct = style==='mla9' ? `(${auth} ${page}).` : (style==='harvard' ? `(${auth} ${year}).` : `(${auth}, ${year}).`);
            } else if (scenarioType === 3) {
                questionStem = `Assuming that you are citing a direct quote by an author on page ${page}, select the correct syntax from the following:`;
                if(style==='apa7') correct = `${auth} (${year}, p. ${page}) states...`;
                else if(style==='mla9') correct = `${auth} states... (${page}).`;
                else if(style==='harvard') correct = `${auth} (${year}: ${page}) states...`;
                else correct = `${auth} (${year}, ${page}) states...`;
            } else {
                questionStem = "Select the correct way to cite multiple authors from the four options below:";
                let n = rawAuthors.map(a => a.last);
                correct = style==='mla9' ? `(${n.join('; ')}).` : `(${n[0]}, ${year}; ${n[1]}, ${year-1}; ${n[2]}, ${year-2}).`;
            }

            let d1 = correct.replace(/\(/g,'').replace(/\)/g,'');
            let d2 = correct.replace(/;/g,',');
            let d3 = correct.replace(`${year}`, `p.${page}`);
            const options = shuffleArray([correct, d1, d2, d3]);

            return {
                sentence: questionStem,
                correctOption: correct,
                options: options,
                hint: `Style: ${style.toUpperCase()}`
            };
        }

        // --- Other Generators (Non-Books) ---
        function generateApaEditedBook(getUniqueItem) { 
            const title=getUniqueItem('bookTitles'), pub=getUniqueItem('publisherLocations').publisher, year=2024, eds="Smith, J.";
            return { scenario: `Edited book "${title}" (${eds}). ${pub}, ${year}.`, components: {content:[`Smith, J. (Ed.).`,`(${year}).`,`<i>${title}</i>.`,`${pub}.`], structure:'{0} {1} {2} {3}', distractors:['(Eds.)']}, hint:'APA 7 Edited Book', originalTitle:title };
        }
        function generateApaJournal(getUniqueItem) { return { scenario:"Journal Article", components:{content:['Auth.','(2022).','Title.','<i>Journal</i>','10(2).'], structure:'{0} {1} {2} {3}, {4}', distractors:[]}, hint:'', originalTitle:'' }; } 
        function generateApaWebsite(getUniqueItem) { return { scenario:"Website", components:{content:['Org.','(2022).','Title.','URL'], structure:'{0} {1} <i>{2}</i>. {3}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateMlaEditedBook(getUniqueItem) { return { scenario:"MLA Edited", components:{content:['Ed, editor.','Title.','Pub,','2022.'], structure:'{0} <i>{1}</i> {2} {3}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateMlaJournal(getUniqueItem) { return { scenario:"MLA Journal", components:{content:['Auth.','Title.','Journal','vol. 1','2022.'], structure:'{0} "{1}" <i>{2}</i>, {3}, {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateMlaWebsite(getUniqueItem) { return { scenario:"MLA Web", components:{content:['Title.','Site,','2022,','URL.'], structure:'"{0}" <i>{1}</i> {2} {3}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateHarvardEditedBook(getUniqueItem) { return { scenario:"Harvard Edited", components:{content:['Ed (ed.)','(2022)','Title.','Place:','Pub.'], structure:'{0} {1} <i>{2}</i> {3} {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateHarvardJournal(getUniqueItem) { return { scenario:"Harvard Journal", components:{content:['Auth','(2022)','Title.','Journal,','10,'], structure:'{0} {1} \'{2}\', <i>{3}</i> {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateHarvardWebsite(getUniqueItem) { return { scenario:"Harvard Web", components:{content:['Org','(2022)','Title.','URL'], structure:'{0} {1} <i>{2}</i>. Available at: {3}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateChicagoEditedBook(getUniqueItem) { return { scenario:"Chicago Edited", components:{content:['Ed, ed.','Title.','Place:','Pub,','2022.'], structure:'{0} <i>{1}</i>. {2} {3} {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateChicagoJournal(getUniqueItem) { return { scenario:"Chicago Journal", components:{content:['Auth.','Title.','Journal','10','(2022).'], structure:'{0} "{1}." <i>{2}</i> {3} {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateChicagoWebsite(getUniqueItem) { return { scenario:"Chicago Web", components:{content:['Org.','Title.','URL.'], structure:'{0} "{1}." {2}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateMhraEditedBook(getUniqueItem) { return { scenario:"MHRA Edited", components:{content:['Ed, ed.,','Title','(Place:','Pub,','2022)'], structure:'{0} <i>{1}</i> {2} {3} {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateMhraJournal(getUniqueItem) { return { scenario:"MHRA Journal", components:{content:['Auth,','Title,','Journal,','10','(2022)'], structure:'{0} \'{1}\', <i>{2}</i>, {3} {4}', distractors:[]}, hint:'', originalTitle:'' }; }
        function generateMhraWebsite(getUniqueItem) { return { scenario:"MHRA Web", components:{content:['Org,','Title','(2022)','URL'], structure:'{0} \'{1}\' {2} <{3}>', distractors:[]}, hint:'', originalTitle:'' }; }

        document.addEventListener('DOMContentLoaded', () => {
            const landingPage = document.getElementById('landingPage');
            const generatorPage = document.getElementById('generatorPage');
            const getStartedBtn = document.getElementById('getStartedBtn');
            const homeTitle = document.getElementById('homeTitle');
            const categorySelect = document.getElementById('questionCategory');
            const subCategoryContainer = document.getElementById('subCategoryContainer');

            if (localStorage.getItem('currentPage') === 'generator') {
                landingPage.style.display = 'none';
                generatorPage.classList.remove('hidden');
            }

            getStartedBtn.addEventListener('click', () => {
                localStorage.setItem('currentPage', 'generator');
                landingPage.style.transition = 'opacity 0.5s';
                landingPage.style.opacity = '0';
                setTimeout(() => {
                    landingPage.style.display = 'none';
                    generatorPage.classList.remove('hidden');
                    generatorPage.classList.add('fade-in-up');
                }, 500);
            });
            
            homeTitle.addEventListener('click', () => {
                localStorage.removeItem('currentPage');
                window.location.reload();
            });

            categorySelect.addEventListener('change', () => {
                if (categorySelect.value === 'in_text') {
                    subCategoryContainer.classList.remove('hidden');
                } else {
                    subCategoryContainer.classList.add('hidden');
                }
            });

            document.getElementById('generateBtn').addEventListener('click', generateQuestions);
            document.getElementById('downloadBtn').addEventListener('click', generateDocx);
            
            document.getElementById('citationStyle').addEventListener('change', () => { updateSourceTypes(); });
            updateSourceTypes();
            
            // Canvas
            const canvas = document.getElementById('landingCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particlesArray;
            const mouse = { x: null, y: null, radius: (canvas.height/100) * (canvas.width/100) };
            window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });
            class Particle { constructor(x,y,dx,dy,s,c) { this.x=x;this.y=y;this.dx=dx;this.dy=dy;this.s=s;this.c=c; } draw() { ctx.beginPath(); ctx.arc(this.x,this.y,this.s,0,Math.PI*2); ctx.fillStyle=this.c; ctx.fill(); } update() { if(this.x>canvas.width||this.x<0) this.dx=-this.dx; if(this.y>canvas.height||this.y<0) this.dy=-this.dy; this.x+=this.dx; this.y+=this.dy; this.draw(); } }
            function initCanvas() { particlesArray = []; let n = (canvas.height * canvas.width) / 9000; for(let i=0;i<n;i++) { let s=(Math.random()*3)+1; let x=Math.random()*innerWidth; let y=Math.random()*innerHeight; let dx=(Math.random()*0.6)-0.3; let dy=(Math.random()*0.6)-0.3; particlesArray.push(new Particle(x,y,dx,dy,s,'rgba(99, 102, 241, 0.6)')); } }
            function animate() { requestAnimationFrame(animate); ctx.clearRect(0,0,innerWidth,innerHeight); for(let i=0;i<particlesArray.length;i++) particlesArray[i].update(); }
            window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; initCanvas(); });
            initCanvas(); animate();
        });

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            const ta = document.createElement('textarea');
            ta.value = el.innerText;
            document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            showMessageBox('Copied to clipboard!', 'success');
        }

        function generateDocx() {
            if (lastGeneratedQuestions.length === 0) { showMessageBox("Please generate some questions first!", 'error'); return; }
            const doc = new docx.Document({ sections: [{ children: lastGeneratedQuestions.flatMap((q, i) => {
                const lines = q.split('\n');
                const children = [new docx.Paragraph({ text: `Question ${i + 1}`, heading: docx.HeadingLevel.HEADING_1, spacing: { after: 200 } })];
                lines.slice(2).forEach(line => { if (line.trim() !== '') children.push(new docx.Paragraph({ text: line })); });
                if (i < lastGeneratedQuestions.length - 1) children.push(new docx.Paragraph({ children: [new docx.PageBreak()] }));
                return children;
            }) }] });
            docx.Packer.toBlob(doc).then(blob => { saveAs(blob, "citex-questions.docx"); });
        }
    </script>
</body>
</html>
